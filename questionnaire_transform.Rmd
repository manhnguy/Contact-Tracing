---
title: "Export data from KoboToolbox tutorial"
output: html_document
date: "2022-12-12"
---

```{r setup, include=FALSE, message= F}
knitr::opts_chunk$set(echo = TRUE)
library(KoboconnectR) #download the data from kobotool box
library(magrittr) #use the pipe %<>%
library(tidygeocoder) #get longitude and latitude from the address
library(igraph) #make the network
library(leaflet) #make the map
library(sp) #make sp file, use spChFIDs(), SpatialLines, function
library(tidyverse)
library(shiny)
library(leaflet.extras2) #to make the arrows on the map, the arrows show on html only. function addArrowhead() it will show on html only
```

## Data structure
![](data_structure.png){align=center}


```{r download data from kobo, message=F, echo=F}
df <- readRDS("df.rds")
## get data from different sheets
main_spreadsheet <- df[["Contact tracing questionnair..."]] #main linelist
symptom_group <- df[["symptom_group"]]
testing_group <- df[["testing_group"]]
quarantine_place <- df[["quarantine_place"]]
quarantine_mate_list <- df[["quarantine_mate_list"]]
travel_abroad_group <- df[["travel_abroad_group"]]
enter_vietnam_group <- df[["enter_vietnam_group"]]
source_cases <- df[["source_cases"]]
source_location <- df[["source_location"]]
location_list <- df[["location_list"]]
contacts_list <- df[["contacts_list"]]
vaccine_list <- df[["vaccine_list"]]
```


```{r }
## Main spread sheet: select relative columns
main_spreadsheet%<>%select(-10, -30, -31, -34, -37, -39, -40, -46, -50, -51, -c(55:64), -67, -70, -83, -c(88:95))%>%
  mutate(Street = str_c("duong", Street, sep = " "), #"duong" is street
         Ward = str_c("phuong", Ward, sep = " "), #"phuong" is ward
         District = str_c("quan", District, sep = " "))%>% #"quan" is district
  unite("address", No:Province_City, sep = ", ", remove =F, na.rm = TRUE)%<>% #unite columns to get full address column
  tidygeocoder::geocode(address, method = 'arcgis', lat = lat , lon = lon) # get longitude and latitude from the address
```


```{r }
## Symptoms
df1 <- symptom_group%>%rename("parent_index" = "_parent_index")%>%
  select(6, 1:3)%>%mutate(parent_index = as.character(parent_index),
                          Symptoms_onset_date = as.Date(Symptoms_onset_date))%>%
  group_by(parent_index)%>% mutate(symptom = as.character(row_number()))%>% 
  ungroup()

symptom <- df1%>%
  pivot_wider(names_from = symptom, values_from = c(Type_of_symptoms, Other_symptoms, Symptoms_onset_date))
```


```{r }
##Testing
df1 <- testing_group%>%rename("parent_index" = "_parent_index")%>%
  select(7, 1:4)%>%mutate(parent_index = as.character(parent_index),
                          Test_date = as.Date(Test_date))%>%
  group_by(parent_index)%>% mutate(test = as.character(row_number()))%>% 
  ungroup()

testing <- df1%>%
  pivot_wider(names_from = test, values_from = c(Test_date, Test_place, Type_of_the_test,Test_result))

## Get last negative test
testing <- rename(testing, id = parent_index) 
extract_lastneg <- function(data,id="parent_index",result.name="Test_result",date.name="Test_date"){
           tmp1 <- data %>% select(c(id, starts_with(result.name)))
           tmp2 <- data %>% select(c(id, starts_with(date.name)))
           tmp1 <- tmp1 %>% pivot_longer(!id,values_to="result",values_drop_na=FALSE)
           tmp2 <- tmp2 %>% pivot_longer(!id,values_to="date",values_drop_na=FALSE) %>% mutate(date=as.Date(date))
           out <- data.frame(id=factor(tmp1$id,levels=unique(tmp1$id)), date=tmp2$date, result=tmp1$result)
           out <- out[!(is.na(out$date)&is.na(out$result)),]
           out.id <- out %>% group_by(id) %>%  slice(1) %>% filter(result=="negative")
           out <- out %>% filter(id %in% out.id$id)
           pos <- out %>% group_by(id) %>% filter(row_number()==match("positive",result)-1)%>%select(1,2)
           names(pos) <- c(id,"last_neg_date")
           pos$id <- as.character(pos$id)
           pos
}

last_negative <- (extract_lastneg(testing,"id","Test_result","Test_date"))
testing <- left_join(testing, last_negative)
## Get first positive test
first_positive <- function(x) {
  first(which(x == "positive"))
}

PCR1.pos <- testing %>% 
  select(id, starts_with("Test_date"), starts_with("Test_result"))%>% 
  rowwise()%>% 
  mutate(PCR1.pos = ifelse(!is.na(Test_result_1),magrittr::extract(c_across(Test_date_1:Test_date_2), first_positive(c_across(Test_result_1:Test_result_2))), NA)) %>% 
  mutate(PCR1.pos = as.Date(PCR1.pos, origin = "1970-01-01")) %>% 
  select(PCR1.pos)
  testing <- cbind(testing, PCR1.pos)%>%rename(parent_index = id)
```


```{r }
## making contacts file
df1 <- source_cases%>%select(8, 1, 4, 5)%>%
  rename("parent_index" = "_parent_index")%>%
  mutate(parent_index = as.character(parent_index),
         First_date_exposure = as.Date(First_date_exposure),
         Last_date_exposure = as.Date(Last_date_exposure))%>%
  group_by(parent_index)%>% mutate(no = as.character(row_number()))%>% 
  ungroup()
contact <- df1%>%
  pivot_wider(names_from = no, values_from = c(Name_ID_source, First_date_exposure, Last_date_exposure))
contact$first_exposure <- as.Date(apply(contact%>%select(starts_with("First_date_exposure")), 1, min, na.rm=T))
contact$last_exposure <- as.Date(apply(contact%>%select(starts_with("Last_date_exposure")), 1, max, na.rm=T))
```
## Combine data
```{r}
df1 <- main_spreadsheet%>%rename("index" = "_index")%>%
  mutate(index = as.character(index))%>%
  left_join(symptom, by = c("index" = "parent_index"))%>%
  left_join(testing, by = c("index" = "parent_index"))%>%
  left_join(contact, by = c("index" = "parent_index"))%>%
  rename(Case_ID = Patient_code,
         ID_of_the_source_1 = Name_ID_source_1,
         ID_of_the_source_2 = Name_ID_source_2)%>%
  unite("infector", starts_with("ID_of_the_source"), sep = ",",remove= F, na.rm = T)%>%
  mutate(infector = na_if(infector, ""))

df1$infector <- lapply(df1$infector, function(x) strsplit(x, ",")[[1]]) 

saveRDS(df1, "df1.rds")

df <- readRDS("df1.rds")%>%select(11, 12, 17, 67, 68, 75, 86, 87, 88, 89, 90, 95, 96)
df%<>%mutate(n_row = parse_number(Case_ID))%>%arrange(n_row)%>%select(-14)
saveRDS(df, "df2.rds")
```









